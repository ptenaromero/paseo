<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escanear parada</title>
<link rel="stylesheet" href="../style.css">

<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
    body { margin:0;height:100%; background-color: black;}
    .hud { position:fixed; left:0; right:0; top:0; padding:12px; color:#ffffff; text-align:center;
        font-family:system-ui,sans-serif; background:linear-gradient(to bottom, rgba(0, 0, 0, 0.6), transparent); z-index:10000; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:rgba(0, 0, 0, 0.7); color:#fff;
        padding:10px 14px; border-radius:12px; font-size:14px; display:none; z-index:10000; }
    .fallback { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#0044ff; color:#ffffff;
        padding:10px 14px; border-radius:12px; font-size:14px; display:none; z-index:10000; text-decoration:none; }
    .fallback-menu { position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:rgba(0,0,0,.8); color:#fff;
        padding:12px; border-radius:12px; display:none; z-index:10000; max-width:90%; }
    .fallback-menu a { color:#9ecbff; text-decoration:underline; display:block; margin:4px 0; }
    .a-enter-vr { display:none !important; } /* oculta bot√≥n VR */
</style>
</head>
<body>
    <div class="hud">
        <strong>Apunta a la placa/escudo del monumento</strong><br>
        Al reconocerlo te llevaremos al contenido.
    </div>
    <div id="toast" class="toast">Reconocido: abriendo contenido‚Ä¶</div>
    <a id="fallback" class="fallback bg-light" href="#" style="display:none">Abrir contenido igualmente</a>
    <div id="fallbackMenu" class="fallback-menu"></div>

    <!-- targets.mind en /ruta -->
    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
    >
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- 8 targets (0..7) en el orden del .mind -->
        <a-entity id="t0" mindar-image-target="targetIndex: 0">
        <a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane>
        </a-entity>
        <a-entity id="t1" mindar-image-target="targetIndex: 1"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t2" mindar-image-target="targetIndex: 2"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t3" mindar-image-target="targetIndex: 3"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t4" mindar-image-target="targetIndex: 4"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t5" mindar-image-target="targetIndex: 5"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t6" mindar-image-target="targetIndex: 6"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
        <a-entity id="t7" mindar-image-target="targetIndex: 7"><a-plane position="0 0 0" width="1" height="0.6" opacity="0.0"></a-plane></a-entity>
    </a-scene>

<script>
    // ===== Config =====
    const DEFAULT_URL = null;
    const HOLD_MS = 700;
    const SHOW_FALLBACK_MS = 10000;

    // ===== Par√°metros =====
    const params = new URLSearchParams(location.search);
    const scopeGlobal = params.get("scope") || DEFAULT_URL;
    const onlyParam = params.get("only");
    const only = (onlyParam === null || onlyParam === '') ? null : Number(onlyParam);

    // üÜï LEE EL ORIGEN Y PROP√ÅGALO
    const from = params.get("from") || ""; // <-- üÜï

    // URLs por √≠ndice: ?scope0=...&scope1=...&...&scope7=...
    const scopeByIndex = {};
    for (const [k, v] of params.entries()) {
        const m = k.match(/^scope([0-7])$/);
        if (m) scopeByIndex[Number(m[1])] = v;
    }

    const labelsByIndex = {
        0: "Parada 0", 1: "Parada 1", 2: "Parada 2", 3: "Parada 3",
        4: "Parada 4", 5: "Parada 5", 6: "Parada 6", 7: "Parada 7"
    };

    // ===== Estado =====
    let holdTimer = null;
    let fallbackTimer = null;
    let detected = false;
    let redirected = false;

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    const toRel = (p) => p ? ((/^https?:\/\//.test(p) || p.startsWith('/')) ? p : `./${p}`) : null;

    // üÜï compone una URL destino asegurando que arrastra ?from=...
    function withFrom(dest) {                       // üÜï
        const u = new URL(dest, location.href);
        if (from) u.searchParams.set('from', from);   // adjunta/actualiza from
        return u.pathname + u.search + u.hash;
    }

    function showToast(msg){
        const t = $("#toast");
        t.textContent = msg; t.style.display = "block";
        setTimeout(()=> t.style.display="none", 1200);
    }

    function stopCameraAndScene(){
        try {
            const scene = document.querySelector('a-scene'); scene?.pause();
            const v = document.querySelector('video');
            const tracks = v?.srcObject?.getTracks?.() || [];
            tracks.forEach(tr => tr.stop && tr.stop());
        } catch(e) { /* no-op */ }
    }

    function onLost(){ if (holdTimer){ clearTimeout(holdTimer); holdTimer=null; } }

    function resolveDest(idx){
        if (only !== null && idx !== only) return null;
        if (scopeByIndex[idx]) return toRel(scopeByIndex[idx]);
        if (scopeGlobal) return toRel(scopeGlobal);
        return null;
    }

    function scheduleRedirect(dest){
        if (redirected || !dest) return;
        redirected = true;
        clearTimeout(fallbackTimer);
        $("#fallback").style.display = 'none';
        $("#fallbackMenu").style.display = 'none';
        showToast("Reconocido: abriendo contenido‚Ä¶");
        holdTimer = setTimeout(() => {
            stopCameraAndScene();
            // üÜï usa withFrom() para mantener el origen
            window.location.assign(withFrom(dest));   // üÜï
        }, HOLD_MS);
    }

    // ===== Fallback =====
    function setupFallback(){
        const fb = $("#fallback");
        const menu = $("#fallbackMenu");
        const hasPerIndex = Object.keys(scopeByIndex).length > 0;

      // Bot√≥n simple si hay scope global
        if (scopeGlobal) {
            const dest = toRel(scopeGlobal);
        if (dest) {
            // üÜï respetar 'from' en el fallback
            const href = withFrom(dest);                            // üÜï
            fb.href = href;                                         // üÜï
            fb.onclick = (e)=>{ e.preventDefault(); window.location.assign(href); }; // üÜï
            fallbackTimer = setTimeout(() => {
                if (!detected) fb.style.display = 'inline-block';
            }, SHOW_FALLBACK_MS);
        }
        return;
        }

      // Men√∫ si hay scopes por √≠ndice
        if (hasPerIndex) {
            const items = Object.entries(scopeByIndex)
            .sort(([a],[b]) => Number(a) - Number(b))
            .map(([idx, url]) => {
                const nice = labelsByIndex[idx] ?? `Target ${idx}`;
                // üÜï precomp√≥n href con 'from'
                const href = withFrom(toRel(url));                    // üÜï
                return `<a href="${href}" data-idx="${idx}">${nice}</a>`;
            }).join("");
        if (items) {
            menu.innerHTML = `<div><strong>No se reconoci√≥ ninguna imagen.</strong><br>Abre manualmente:</div>${items}`;
            menu.addEventListener('click', (e) => {
                const a = e.target.closest('a[href]');
                if (!a) return;
                e.preventDefault();
                window.location.assign(a.getAttribute('href'));       // ya lleva ?from=...
            });
            fallbackTimer = setTimeout(() => {
                if (!detected) menu.style.display = 'block';
            }, SHOW_FALLBACK_MS);
        }
        }
    }

    // ===== Bindeo de los 8 targets =====
    function bindAllTargets(){
        document.querySelectorAll('[mindar-image-target]').forEach((el) => {
            const attr = el.getAttribute('mindar-image-target');
            const idx = (typeof attr === 'string')
            ? Number((attr.match(/targetIndex\s*:\s*(\d+)/) || [])[1])
            : (typeof attr === 'object' ? attr.targetIndex : null);
            if (!Number.isFinite(idx)) return;

            el.addEventListener('targetFound', () => {
            if (redirected) return;
            const dest = resolveDest(idx);
            if (!dest) return;
            detected = true;
            clearTimeout(fallbackTimer);
            $("#fallback").style.display = 'none';
            $("#fallbackMenu").style.display = 'none';
            scheduleRedirect(dest); // dentro ya a√±ade ?from=...
            });

            el.addEventListener('targetLost', onLost);
        });
    }

    // Espera a que la escena cargue antes de enlazar
    const scene = document.querySelector('a-scene');
    if (scene.hasLoaded) { bindAllTargets(); setupFallback(); }
    else { scene.addEventListener('loaded', () => { bindAllTargets(); setupFallback(); }); }
</script>
</body>
</html>
